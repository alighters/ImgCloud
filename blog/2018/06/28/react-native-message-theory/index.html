
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>RN 通信 - alighters</title>
  <meta name="author" content="alighters">

  
  <meta name="description" content="RN 通信 2018-06-28 4:28 pm | Comments JS 桥 Android: Webkit 的 JavaScriptCore
ios: 自带的 javascriptcore 在 Android 的代码，其提供了一个 CatalystInstance 的接口，来做 JS 与 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alighters.github.io/blog/blog/2018/06/28/react-native-message-theory/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="alighters" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-77273971-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">alighters</a></h1>
  
    <h2>程序、写作、人生</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="alighters.github.io/blog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">博客</a></li>
  <li><a href="/blog/archives">目录</a></li>
  <li><a href="/about">关于</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">RN 通信</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-28T16:28:00+08:00'><span class='date'>2018-06-28</span> <span class='time'>4:28 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://alighters.github.io/blog">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>JS 桥</h2>

<p>Android: Webkit 的 JavaScriptCore
ios: 自带的 javascriptcore</p>

<p>在 Android 的代码，其提供了一个 CatalystInstance 的接口，来做 JS 与 Native 的高度抽象的接口：</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CatalystInstance</span>
</span><span class='line'>    <span class="kd">extends</span> <span class="n">MemoryPressureListener</span><span class="o">,</span> <span class="n">JSInstance</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">runJSBundle</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Returns the status of running the JS bundle; waits for an answer if runJSBundle is running</span>
</span><span class='line'>  <span class="kt">boolean</span> <span class="nf">hasRunJSBundle</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Return the source URL of the JS Bundle that was run, or {@code null} if no JS</span>
</span><span class='line'><span class="cm">   * bundle has been run yet.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="nf">getSourceURL</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is called from java code, so it won&#39;t be stripped anyway, but proguard will rename it,</span>
</span><span class='line'>  <span class="c1">// which this prevents.</span>
</span><span class='line'>  <span class="nd">@Override</span> <span class="nd">@DoNotStrip</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">invokeCallback</span><span class="o">(</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">callbackID</span><span class="o">,</span>
</span><span class='line'>      <span class="n">NativeArray</span> <span class="n">arguments</span><span class="o">);</span>
</span><span class='line'>  <span class="nd">@DoNotStrip</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">callFunction</span><span class="o">(</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">module</span><span class="o">,</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">method</span><span class="o">,</span>
</span><span class='line'>      <span class="n">NativeArray</span> <span class="n">arguments</span><span class="o">);</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Destroys this catalyst instance, waiting for any other threads in ReactQueueConfiguration</span>
</span><span class='line'><span class="cm">   * (besides the UI thread) to finish running. Must be called from the UI thread so that we can</span>
</span><span class='line'><span class="cm">   * fully shut down other threads.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">destroy</span><span class="o">();</span>
</span><span class='line'>  <span class="kt">boolean</span> <span class="nf">isDestroyed</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Initialize all the native modules</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nd">@VisibleForTesting</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">initialize</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ReactQueueConfiguration</span> <span class="nf">getReactQueueConfiguration</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">JavaScriptModule</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getJSModule</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">jsInterface</span><span class="o">);</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">NativeModule</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">hasNativeModule</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">nativeModuleInterface</span><span class="o">);</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">NativeModule</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getNativeModule</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">nativeModuleInterface</span><span class="o">);</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">JSIModule</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getJSIModule</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">jsiModuleInterface</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Collection</span><span class="o">&lt;</span><span class="n">NativeModule</span><span class="o">&gt;</span> <span class="nf">getNativeModules</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * This method permits a CatalystInstance to extend the known</span>
</span><span class='line'><span class="cm">   * Native modules. This provided registry contains only the new modules to load.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">extendNativeModules</span><span class="o">(</span><span class="n">NativeModuleRegistry</span> <span class="n">modules</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Adds a idle listener for this Catalyst instance. The listener will receive notifications</span>
</span><span class='line'><span class="cm">   * whenever the bridge transitions from idle to busy and vice-versa, where the busy state is</span>
</span><span class='line'><span class="cm">   * defined as there being some non-zero number of calls to JS that haven&#39;t resolved via a</span>
</span><span class='line'><span class="cm">   * onBatchCompleted call. The listener should be purely passive and not affect application logic.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">addBridgeIdleDebugListener</span><span class="o">(</span><span class="n">NotThreadSafeBridgeIdleDebugListener</span> <span class="n">listener</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Removes a NotThreadSafeBridgeIdleDebugListener previously added with</span>
</span><span class='line'><span class="cm">   * {@link #addBridgeIdleDebugListener}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">removeBridgeIdleDebugListener</span><span class="o">(</span><span class="n">NotThreadSafeBridgeIdleDebugListener</span> <span class="n">listener</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** This method registers the file path of an additional JS segment by its ID. */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">registerSegment</span><span class="o">(</span><span class="kt">int</span> <span class="n">segmentId</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@VisibleForTesting</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">setGlobalVariable</span><span class="o">(</span><span class="n">String</span> <span class="n">propName</span><span class="o">,</span> <span class="n">String</span> <span class="n">jsonValue</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Get the C pointer (as a long) to the JavaScriptCore context associated with this instance.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * &lt;p&gt;Use the following pattern to ensure that the JS context is not cleared while you are using</span>
</span><span class='line'><span class="cm">   * it: JavaScriptContextHolder jsContext = reactContext.getJavaScriptContextHolder()</span>
</span><span class='line'><span class="cm">   * synchronized(jsContext) { nativeThingNeedingJsContext(jsContext.get()); }</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">JavaScriptContextHolder</span> <span class="nf">getJavaScriptContextHolder</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">addJSIModules</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">JSIModuleHolder</span><span class="o">&gt;</span> <span class="n">jsiModules</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中主要有 NativeModule 和 JSModule 获取的方法，并调用 JS 侧方法 invokeCallback 和 callFunction 方法。</p>

<h2>执行流程</h2>

<h4>1.构建 ReactNativeHost</h4>

<p>在 ReactNativeHost 中的 getPackages 方法中，我们需要传递实现的 ReactPackage 接口，接口中则定义了实现的 NativeModule 集合和 ViewManager 的集合。</p>

<h4>2.创建 ReactInstanceManger</h4>

<p>ReactNativeHost 是在 application 中提供获取的，而通过 ReactNativeHost 可以获取到 ReactInstanceManager 类，在创建 ReactInstanceManager 的过程中，会得到所有的 ReactPackage，将其保存在 ReactInstanceManager 类中。</p>

<blockquote><p>这里的 ReactPackage 的获取，会优先添加 CoreModulesPackage，其提供了 Android 基础的 Module功能，如 AndroidInfoModule、DeviceEventManageModule、UIManagerModule等。</p>

<p>这里的 UIManagerModule，则是来负责 UI 视图创建的 View 集合，并接受来自 View 的命令来操作更新 View。</p></blockquote>

<h4>3.ReactRootView 执行 startReactApplication</h4>

<p>在一个 RN 的 activity 中，其会在 onCreate 方法中，执行 ReactRootView 的创建工作，之后便是根据创建好的 ReactInstanceManager，来执行 ReactRootView 的 startReactApplication 的方法。</p>

<p>其中会调用 ReactInstanceManager 的 createReactContentInBackground 方法。这里会根据特定的 JS 来源，在一个新的线程执行 createReactContext 方法来创建一个ReactApplicationContext。</p>

<h4>4.createReactContext</h4>

<p>此方法中，首先会处理之前的 ReactPackages 来生成一个 NativeModuleRegistry，其是用来管理 NativeModule 并提供获取调用的功能。</p>

<p>紧接着，便是利用 CatalystInstanceImpl Builder 构造一个 CatalystInstance。在 CatalystInstanceImpl 的初始化方法中，其会利用传递过来的参数，调用 JNI 方法 initializeBridge，其会执行桥的初始化操作，如获取 NativeModule 至 JNI 中的 ModuleRegistry 中。</p>

<p>之后便是调用 CatalystInstance 的 runJSBundle 方法。其会执行 JSBundleLoader 的 loadScript 方法，这里又会调用回 CatalystInstanceImpl 中的几个提供的相关从 jni 中 load JS 内容的方法。这里主要来完成 JS 内容的加载。</p>

<h4>5.setupReactContext</h4>

<p>之后，在 NativeModulesQueueThread 上执行 setupReactContext 的方法，这里会执行 CatalyInstance 的 initalize，主要内容则是初始化所有的 NativeModule。</p>

<p>随之，便是调用 attachRootViewToInstance 方法，其参数为 ReactRootView 和 CatalystInstance。其中最主要的内容便是调用 ReactRootView 的 invokeJsEntryPoint :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="cm">/*package */</span> <span class="kt">void</span> <span class="nf">invokeJSEntryPoint</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mJSEntryPoint</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">defaultJSEntryPoint</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mJSEntryPoint</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中 defaultJsEntryPoint 方法，则是调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Calls the default entry point into JS which is AppRegistry.runApplication()</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">defaultJSEntryPoint</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Systrace</span><span class="o">.</span><span class="na">beginSection</span><span class="o">(</span><span class="n">TRACE_TAG_REACT_JAVA_BRIDGE</span><span class="o">,</span> <span class="s">&quot;ReactRootView.runApplication&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mReactInstanceManager</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mIsAttachedToInstance</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ReactContext</span> <span class="n">reactContext</span> <span class="o">=</span> <span class="n">mReactInstanceManager</span><span class="o">.</span><span class="na">getCurrentReactContext</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">reactContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">CatalystInstance</span> <span class="n">catalystInstance</span> <span class="o">=</span> <span class="n">reactContext</span><span class="o">.</span><span class="na">getCatalystInstance</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">WritableNativeMap</span> <span class="n">appParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">WritableNativeMap</span><span class="o">();</span>
</span><span class='line'>        <span class="n">appParams</span><span class="o">.</span><span class="na">putDouble</span><span class="o">(</span><span class="s">&quot;rootTag&quot;</span><span class="o">,</span> <span class="n">getRootViewTag</span><span class="o">());</span>
</span><span class='line'>        <span class="nd">@Nullable</span> <span class="n">Bundle</span> <span class="n">appProperties</span> <span class="o">=</span> <span class="n">getAppProperties</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">appProperties</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">appParams</span><span class="o">.</span><span class="na">putMap</span><span class="o">(</span><span class="s">&quot;initialProps&quot;</span><span class="o">,</span> <span class="n">Arguments</span><span class="o">.</span><span class="na">fromBundle</span><span class="o">(</span><span class="n">appProperties</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">getUIManagerType</span><span class="o">()</span> <span class="o">==</span> <span class="n">FABRIC</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">appParams</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">&quot;fabric&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mShouldLogContentAppeared</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">jsAppModuleName</span> <span class="o">=</span> <span class="n">getJSModuleName</span><span class="o">();</span>
</span><span class='line'>        <span class="n">catalystInstance</span><span class="o">.</span><span class="na">getJSModule</span><span class="o">(</span><span class="n">AppRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">runApplication</span><span class="o">(</span><span class="n">jsAppModuleName</span><span class="o">,</span> <span class="n">appParams</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Systrace</span><span class="o">.</span><span class="na">endSection</span><span class="o">(</span><span class="n">TRACE_TAG_REACT_JAVA_BRIDGE</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出，这里的关键内容便是将 rootTag、initialProps 参数内容，放置在 appParams 中，调用 JS 侧的对象 AppRegistry，并调用其 runApplication 方法，来完成 JS 端内容的调用。</p>

<h2>JS 调用 Native</h2>

<p>将 Native 的方法提供给 JS 来调用，</p>

<h3>1.步骤</h3>

<ul>
<li>1）Native 端定义实现 NativeModule 接口</li>
<li>2）将此 NativeModule 接口添加至 ReactPackage 中</li>
<li>3）JS 端在 NativeModule.js 中获取到指定的 Module 对象，根据提供的方法进行调用。</li>
</ul>


<h3>2.实现</h3>

<h4>1.获取 Native 对象</h4>

<p>在获取一个 Native 端提供的类、对象，通常系统的，我们都是通过 &lsquo;react-native&rsquo; 中获取，而我们自定义的模块则需要从 NativeModule 中获取，以 ToastAndroid 为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">ToastAndroid</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-native&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中，ToastAndroid 对应着 ToastAndroid.android.js，其文件中的 ToastAndroid 内容则是 RCTToastAndroid，其获取方式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="p">{</span> <span class="nx">ToastAndroid</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;NativeModule&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">RCTToastAndroid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;NativeModules&#39;</span><span class="p">).</span><span class="nx">ToastAndroid</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.NativeModule 属性对象的赋值</h4>

<p>在 NativeModule.js 中，NativeModule 对象的生成过程中，其已经调用了 NativeModule 的 genModule 方法，生成了相应的 Module，并赋值了 NativeModule 对象。</p>

<p>其中 genModule 的参数为 ModuleConfig 和 moduleID 的数字类型值。ModuleConfig 的定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">type</span> <span class="nx">ModuleConfig</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>  <span class="nx">string</span><span class="p">,</span> <span class="cm">/* name */</span>
</span><span class='line'>  <span class="o">?</span><span class="nb">Object</span><span class="p">,</span> <span class="cm">/* constants */</span>
</span><span class='line'>  <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="cm">/* functions */</span>
</span><span class='line'>  <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">number</span><span class="o">&gt;</span><span class="p">,</span> <span class="cm">/* promise method IDs */</span>
</span><span class='line'>  <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">number</span><span class="o">&gt;</span><span class="p">,</span> <span class="cm">/* sync method IDs */</span>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>它包含了一个模块的名称、常量值、方法。其中 promise 及 sync 的方法采用方法数组索引来表示。
另外，moduleID 为 module 数组中的索引值。</p>

<p>而调用 genModule 方法，则是根据此 config 信息，生成一个对应的 module 对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kr">const</span> <span class="p">[</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">promiseMethods</span><span class="p">,</span> <span class="nx">syncMethods</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">constants</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Module contents will be filled in lazily later</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">moduleName</span> <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="nx">methods</span> <span class="o">&amp;&amp;</span> <span class="nx">methods</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">methodName</span><span class="p">,</span> <span class="nx">methodID</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">isPromise</span> <span class="o">=</span> <span class="nx">promiseMethods</span> <span class="o">&amp;&amp;</span> <span class="nx">arrayContains</span><span class="p">(</span><span class="nx">promiseMethods</span><span class="p">,</span> <span class="nx">methodID</span><span class="p">);</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">isSync</span> <span class="o">=</span> <span class="nx">syncMethods</span> <span class="o">&amp;&amp;</span> <span class="nx">arrayContains</span><span class="p">(</span><span class="nx">syncMethods</span><span class="p">,</span> <span class="nx">methodID</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">invariant</span><span class="p">(</span><span class="o">!</span><span class="nx">isPromise</span> <span class="o">||</span> <span class="o">!</span><span class="nx">isSync</span><span class="p">,</span> <span class="s1">&#39;Cannot have a method that is both async and a sync hook&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">methodType</span> <span class="o">=</span> <span class="nx">isPromise</span> <span class="o">?</span> <span class="s1">&#39;promise&#39;</span> <span class="o">:</span> <span class="nx">isSync</span> <span class="o">?</span> <span class="s1">&#39;sync&#39;</span> <span class="o">:</span> <span class="s1">&#39;async&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">module</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">genMethod</span><span class="p">(</span><span class="nx">moduleID</span><span class="p">,</span> <span class="nx">methodID</span><span class="p">,</span> <span class="nx">methodType</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">constants</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">BatchedBridge</span><span class="p">.</span><span class="nx">createDebugLookup</span><span class="p">(</span><span class="nx">moduleID</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">module</span> <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>若是存在方法值，则会遍历方法，调用 genMethod 来生成方法对应的信息：</p>

<p>之后便是将其赋值给 NativeModule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">genModule</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">moduleID</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">NativeModules</span><span class="p">[</span><span class="nx">info</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">module</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>3.__fbBatchedBridgeConfig 的生成及赋值</h4>

<p>在上述2的步骤中，其中 config 数组信息对应着 bridgeConfig 的属性 remoteModuleConfig。而 bridgeConfig 则是 global.__fbBatchedBridgeConfig 的值。</p>

<p>这个值则是在 JS 引擎的 ProxyExecutor 执行 loadApplicationScript 中进行赋值的:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">void</span> <span class="nx">ProxyExecutor</span><span class="o">::</span><span class="nx">loadApplicationScript</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">std</span><span class="o">::</span><span class="nx">unique_ptr</span><span class="o">&lt;</span><span class="kr">const</span> <span class="nx">JSBigString</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">std</span><span class="o">::</span><span class="nx">string</span> <span class="nx">sourceURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">folly</span><span class="o">::</span><span class="nx">dynamic</span> <span class="nx">nativeModuleConfig</span> <span class="o">=</span> <span class="nx">folly</span><span class="o">::</span><span class="nx">dynamic</span><span class="o">::</span><span class="nx">array</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">SystraceSection</span> <span class="nx">s</span><span class="p">(</span><span class="s2">&quot;collectNativeModuleDescriptions&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">auto</span> <span class="nx">moduleRegistry</span> <span class="o">=</span> <span class="nx">m_delegate</span><span class="o">-&gt;</span><span class="nx">getModuleRegistry</span><span class="p">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">auto</span><span class="o">&amp;</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">moduleRegistry</span><span class="o">-&gt;</span><span class="nx">moduleNames</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">auto</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">moduleRegistry</span><span class="o">-&gt;</span><span class="nx">getConfig</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">nativeModuleConfig</span><span class="p">.</span><span class="nx">push_back</span><span class="p">(</span><span class="nx">config</span> <span class="o">?</span> <span class="nx">config</span><span class="o">-&gt;</span><span class="nx">config</span> <span class="o">:</span> <span class="nx">nullptr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">folly</span><span class="o">::</span><span class="nx">dynamic</span> <span class="nx">config</span> <span class="o">=</span>
</span><span class='line'>    <span class="nx">folly</span><span class="o">::</span><span class="nx">dynamic</span><span class="o">::</span><span class="nx">object</span>
</span><span class='line'>    <span class="p">(</span><span class="s2">&quot;remoteModuleConfig&quot;</span><span class="p">,</span> <span class="nx">std</span><span class="o">::</span><span class="nx">move</span><span class="p">(</span><span class="nx">nativeModuleConfig</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">SystraceSection</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&quot;setGlobalVariable&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">setGlobalVariable</span><span class="p">(</span>
</span><span class='line'>      <span class="s2">&quot;__fbBatchedBridgeConfig&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">folly</span><span class="o">::</span><span class="nx">make_unique</span><span class="o">&lt;</span><span class="nx">JSBigStdString</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">folly</span><span class="o">::</span><span class="nx">toJson</span><span class="p">(</span><span class="nx">config</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">static</span> <span class="nx">auto</span> <span class="nx">loadApplicationScript</span> <span class="o">=</span>
</span><span class='line'>    <span class="nx">jni</span><span class="o">::</span><span class="nx">findClassStatic</span><span class="p">(</span><span class="nx">EXECUTOR_BASECLASS</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">getMethod</span><span class="o">&lt;</span><span class="k">void</span><span class="p">(</span><span class="nx">jstring</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;loadApplicationScript&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The proxy ignores the script data passed in.</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">loadApplicationScript</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">m_executor</span><span class="p">.</span><span class="nx">get</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">jni</span><span class="o">::</span><span class="nx">make_jstring</span><span class="p">(</span><span class="nx">sourceURL</span><span class="p">).</span><span class="nx">get</span><span class="p">());</span>
</span><span class='line'>  <span class="c1">// We can get pending calls here to native but the queue will be drained when</span>
</span><span class='line'>  <span class="c1">// we launch the application.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里利用 ExecutorDelegate 得到 ModuleRegistry，通过其获取到 moduleNames，进行遍历获取到每个 module 对应的 config 信息，将这些 config 信息放置在 nativeModuleConfig 数组中，并将其封装为 remoteModuleConfig 对象，调用 setGlobalVariable 方法，将此对象存放至名为 __fbBatchedBridgeConfig 的变量中。</p>

<h4>4.JNI NativeModule 的注册</h4>

<p>在上述过程中，就有个问题，NativeModule 是如何存在于 ModuleRegistry 中的?</p>

<p>首先暴露 JNI 相关的方法是在 OnLoad.cpp 的 JNI_OnLoad 方法中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>    <span class="nx">extern</span> <span class="s2">&quot;C&quot;</span> <span class="nx">JNIEXPORT</span> <span class="nx">jint</span> <span class="nx">JNI_OnLoad</span><span class="p">(</span><span class="nx">JavaVM</span> <span class="o">*</span><span class="nx">vm</span><span class="p">,</span> <span class="k">void</span> <span class="o">*</span><span class="nx">reserved</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="p">[]</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">gloginit</span><span class="o">::</span><span class="nx">initialize</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">JSCJavaScriptExecutorHolder</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">ProxyJavaScriptExecutorHolder</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">CxxModuleWrapperBase</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">CxxModuleWrapper</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">JCxxCallbackImpl</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">NativeArray</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">ReadableNativeArray</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">WritableNativeArray</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">NativeMap</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">ReadableNativeMap</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">WritableNativeMap</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">ReadableNativeMapKeySetIterator</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span><span class="nx">ifdef</span> <span class="nx">WITH_INSPECTOR</span>
</span><span class='line'>          <span class="nx">JInspector</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'><span class="err">#</span><span class="nx">endif</span>
</span><span class='line'>      <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>其调用了 CatalystInstanceImpl::registerNatives() 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">void</span> <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">registerHybrid</span><span class="p">({</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;initHybrid&quot;</span><span class="p">,</span> <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">initHybrid</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;initializeBridge&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">initializeBridge</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniExtendNativeModules&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">extendNativeModules</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniSetSourceURL&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniSetSourceURL</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniRegisterSegment&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniRegisterSegment</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniLoadScriptFromAssets&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniLoadScriptFromAssets</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniLoadScriptFromFile&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniLoadScriptFromFile</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniCallJSFunction&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniCallJSFunction</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniCallJSCallback&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">jniCallJSCallback</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;setGlobalVaeeriable&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">setGlobalVariable</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;getJavaScriptContext&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">getJavaScriptContext</span><span class="p">),</span>
</span><span class='line'>                   <span class="nx">makeNativeMethod</span><span class="p">(</span><span class="s2">&quot;jniHandleMemoryPressure&quot;</span><span class="p">,</span>
</span><span class='line'>                                    <span class="nx">CatalystInstanceImpl</span><span class="o">::</span><span class="nx">handleMemoryPressure</span><span class="p">),</span>
</span><span class='line'>                 <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">JNativeRunnable</span><span class="o">::</span><span class="nx">registerNatives</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到 CatalystInstanceImpl::initializeBridge 方法绑定为 initializeBridge JNI 方法，而此 JNI 方法的调用则是在初始化 CatalystInstanceImpl 的构造函数中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">private</span> <span class="nf">CatalystInstanceImpl</span><span class="o">(</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">ReactQueueConfigurationSpec</span> <span class="n">reactQueueConfigurationSpec</span><span class="o">,</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">JavaScriptExecutor</span> <span class="n">jsExecutor</span><span class="o">,</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">NativeModuleRegistry</span> <span class="n">nativeModuleRegistry</span><span class="o">,</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">JSBundleLoader</span> <span class="n">jsBundleLoader</span><span class="o">,</span>
</span><span class='line'>      <span class="n">NativeModuleCallExceptionHandler</span> <span class="n">nativeModuleCallExceptionHandler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">ReactConstants</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&quot;Initializing React Xplat Bridge.&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mHybridData</span> <span class="o">=</span> <span class="n">initHybrid</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mReactQueueConfiguration</span> <span class="o">=</span> <span class="n">ReactQueueConfigurationImpl</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
</span><span class='line'>        <span class="n">reactQueueConfigurationSpec</span><span class="o">,</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">NativeExceptionHandler</span><span class="o">());</span>
</span><span class='line'>    <span class="n">mBridgeIdleListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>    <span class="n">mNativeModuleRegistry</span> <span class="o">=</span> <span class="n">nativeModuleRegistry</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mJSModuleRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JavaScriptModuleRegistry</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mJSBundleLoader</span> <span class="o">=</span> <span class="n">jsBundleLoader</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mNativeModuleCallExceptionHandler</span> <span class="o">=</span> <span class="n">nativeModuleCallExceptionHandler</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mNativeModulesQueueThread</span> <span class="o">=</span> <span class="n">mReactQueueConfiguration</span><span class="o">.</span><span class="na">getNativeModulesQueueThread</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mTraceListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JSProfilerTraceListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">ReactConstants</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&quot;Initializing React Xplat Bridge before initializeBridge&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">initializeBridge</span><span class="o">(</span>
</span><span class='line'>      <span class="k">new</span> <span class="nf">BridgeCallback</span><span class="o">(</span><span class="k">this</span><span class="o">),</span>
</span><span class='line'>      <span class="n">jsExecutor</span><span class="o">,</span>
</span><span class='line'>      <span class="n">mReactQueueConfiguration</span><span class="o">.</span><span class="na">getJSQueueThread</span><span class="o">(),</span>
</span><span class='line'>      <span class="n">mNativeModulesQueueThread</span><span class="o">,</span>
</span><span class='line'>      <span class="n">mNativeModuleRegistry</span><span class="o">.</span><span class="na">getJavaModules</span><span class="o">(</span><span class="k">this</span><span class="o">),</span>
</span><span class='line'>      <span class="n">mNativeModuleRegistry</span><span class="o">.</span><span class="na">getCxxModules</span><span class="o">());</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">ReactConstants</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&quot;Initializing React Xplat Bridge after initializeBridge&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mJavaScriptContextHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JavaScriptContextHolder</span><span class="o">(</span><span class="n">getJavaScriptContext</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中调用的 initializeBridge 调用的 Native 方法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">CatalystInstanceImpl:</span><span class="o">:</span><span class="n">initializeBridge</span><span class="o">(</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">ReactCallback:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">,</span>
</span><span class='line'>  <span class="c1">// This executor is actually a factory holder.</span>
</span><span class='line'>  <span class="n">JavaScriptExecutorHolder</span> <span class="o">*</span><span class="n">jseh</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">JavaMessageQueueThread:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">jsQueue</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">JavaMessageQueueThread:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">nativeModulesQueue</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">jni:</span><span class="o">:</span><span class="n">JCollection</span><span class="o">&lt;</span><span class="nl">JavaModuleWrapper:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;::</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">javaModules</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">jni:</span><span class="o">:</span><span class="n">JCollection</span><span class="o">&lt;</span><span class="nl">ModuleHolder:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;::</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">cxxModules</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduleMessageQueue_</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">JMessageQueueThread</span><span class="o">&gt;(</span><span class="n">nativeModulesQueue</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduleRegistry_</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ModuleRegistry</span><span class="o">&gt;(</span>
</span><span class='line'>    <span class="n">buildNativeModuleList</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">std:</span><span class="o">:</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">Instance</span><span class="o">&gt;(</span><span class="n">instance_</span><span class="o">),</span>
</span><span class='line'>      <span class="n">javaModules</span><span class="o">,</span>
</span><span class='line'>      <span class="n">cxxModules</span><span class="o">,</span>
</span><span class='line'>      <span class="n">moduleMessageQueue_</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">instance_</span><span class="o">-&gt;</span><span class="n">initializeBridge</span><span class="o">(</span>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">JInstanceCallback</span><span class="o">&gt;(</span>
</span><span class='line'>      <span class="n">callback</span><span class="o">,</span>
</span><span class='line'>      <span class="n">moduleMessageQueue_</span><span class="o">),</span>
</span><span class='line'>    <span class="n">jseh</span><span class="o">-&gt;</span><span class="n">getExecutorFactory</span><span class="o">(),</span>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">JMessageQueueThread</span><span class="o">&gt;(</span><span class="n">jsQueue</span><span class="o">),</span>
</span><span class='line'>    <span class="n">moduleRegistry_</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中实现初始化了 moduleRegistry，这里调用了 buildNativeModuleList 方法，其对应这 ModuleRegistryBuilder 类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">std:</span><span class="o">:</span><span class="n">vector</span> <span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NativeModule</span><span class="o">&gt;&gt;</span> <span class="nf">buildNativeModuleList</span><span class="o">(</span>
</span><span class='line'>  <span class="nl">std:</span><span class="o">:</span><span class="n">weak_ptr</span> <span class="o">&lt;</span><span class="n">Instance</span><span class="o">&gt;</span> <span class="n">winstance</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">jni:</span><span class="o">:</span><span class="n">JCollection</span><span class="o">&lt;</span><span class="nl">JavaModuleWrapper:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;::</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">javaModules</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">jni:</span><span class="o">:</span><span class="n">alias_ref</span> <span class="o">&lt;</span><span class="nl">jni:</span><span class="o">:</span><span class="n">JCollection</span><span class="o">&lt;</span><span class="nl">ModuleHolder:</span><span class="o">:</span><span class="n">javaobject</span><span class="o">&gt;::</span><span class="n">javaobject</span><span class="o">&gt;</span> <span class="n">cxxModules</span><span class="o">,</span>
</span><span class='line'>  <span class="nl">std:</span><span class="o">:</span><span class="n">shared_ptr</span> <span class="o">&lt;</span><span class="n">MessageQueueThread</span><span class="o">&gt;</span> <span class="n">moduleMessageQueue</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="nl">std:</span><span class="o">:</span><span class="n">vector</span> <span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">NativeModule</span><span class="o">&gt;&gt;</span> <span class="n">modules</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">javaModules</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kd">const</span> <span class="n">auto</span> <span class="o">&amp;</span><span class="n">jm</span> <span class="o">:</span> <span class="o">*</span><span class="n">javaModules</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">modules</span><span class="o">.</span><span class="na">emplace_back</span><span class="o">(</span><span class="nl">folly:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">JavaNativeModule</span><span class="o">&gt;(</span>
</span><span class='line'>        <span class="n">winstance</span><span class="o">,</span> <span class="n">jm</span><span class="o">,</span> <span class="n">moduleMessageQueue</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">cxxModules</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kd">const</span> <span class="n">auto</span> <span class="o">&amp;</span><span class="n">cm</span> <span class="o">:</span> <span class="o">*</span><span class="n">cxxModules</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">modules</span><span class="o">.</span><span class="na">emplace_back</span><span class="o">(</span><span class="nl">folly:</span><span class="o">:</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">CxxNativeModule</span><span class="o">&gt;(</span>
</span><span class='line'>        <span class="n">winstance</span><span class="o">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">getName</span><span class="o">(),</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">getProvider</span><span class="o">(),</span> <span class="n">moduleMessageQueue</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">modules</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里则会遍历 javaModules 和延迟加载的 cxxModules，全部存放于类型为 NativeModule 的数组中，由此得到 ModuleRegistry 中，这样便可生成 config 信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">folly:</span><span class="o">:</span><span class="n">Optional</span> <span class="o">&lt;</span><span class="n">ModuleConfig</span><span class="o">&gt;</span> <span class="nl">ModuleRegistry:</span><span class="o">:</span><span class="n">getConfig</span><span class="o">(</span><span class="kd">const</span> <span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">SystraceSection</span> <span class="nf">s</span><span class="o">(</span><span class="s">&quot;ModuleRegistry::getConfig&quot;</span><span class="o">,</span> <span class="s">&quot;module&quot;</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Initialize modulesByName_</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">modulesByName_</span><span class="o">.</span><span class="na">empty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">modules_</span><span class="o">.</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">moduleNames</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">modulesByName_</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">modulesByName_</span><span class="o">.</span><span class="na">end</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">unknownModules_</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">!=</span> <span class="n">unknownModules_</span><span class="o">.</span><span class="na">end</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">nullptr</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">moduleNotFoundCallback_</span> <span class="o">||</span>
</span><span class='line'>        <span class="o">!</span><span class="n">moduleNotFoundCallback_</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="o">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">modulesByName_</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">==</span> <span class="n">modulesByName_</span><span class="o">.</span><span class="na">end</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">unknownModules_</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">nullptr</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">size_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">CHECK</span><span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">modules_</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span><span class='line'>  <span class="n">NativeModule</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span> <span class="n">modules_</span><span class="o">[</span><span class="n">index</span><span class="o">].</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// string name, object constants, array methodNames (methodId is index), [array promiseMethodIds], [array syncMethodIds]</span>
</span><span class='line'>  <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="n">config</span> <span class="o">=</span> <span class="nl">folly:</span><span class="o">:</span><span class="nl">dynamic:</span><span class="o">:</span><span class="n">array</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="n">SystraceSection</span> <span class="nf">s_</span><span class="o">(</span><span class="s">&quot;getConstants&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">getConstants</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="n">SystraceSection</span> <span class="nf">s_</span><span class="o">(</span><span class="s">&quot;getMethods&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="nl">std:</span><span class="o">:</span><span class="n">vector</span> <span class="o">&lt;</span><span class="n">MethodDescriptor</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">getMethods</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="n">methodNames</span> <span class="o">=</span> <span class="nl">folly:</span><span class="o">:</span><span class="nl">dynamic:</span><span class="o">:</span><span class="n">array</span><span class="o">;</span>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="n">promiseMethodIds</span> <span class="o">=</span> <span class="nl">folly:</span><span class="o">:</span><span class="nl">dynamic:</span><span class="o">:</span><span class="n">array</span><span class="o">;</span>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="n">syncMethodIds</span> <span class="o">=</span> <span class="nl">folly:</span><span class="o">:</span><span class="nl">dynamic:</span><span class="o">:</span><span class="n">array</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">auto</span> <span class="o">&amp;</span><span class="n">descriptor</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// TODO: #10487027 compare tags instead of doing string comparison?</span>
</span><span class='line'>      <span class="n">methodNames</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">descriptor</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">descriptor</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="s">&quot;promise&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">promiseMethodIds</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="n">methodNames</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">descriptor</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="s">&quot;sync&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">syncMethodIds</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="n">methodNames</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">methodNames</span><span class="o">.</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">methodNames</span><span class="o">));</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(!</span><span class="n">promiseMethodIds</span><span class="o">.</span><span class="na">empty</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">syncMethodIds</span><span class="o">.</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">config</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">promiseMethodIds</span><span class="o">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">syncMethodIds</span><span class="o">.</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">config</span><span class="o">.</span><span class="na">push_back</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">syncMethodIds</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">empty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// no constants or methods</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">nullptr</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ModuleConfig</span><span class="o">{</span><span class="n">index</span><span class="o">,</span> <span class="n">config</span><span class="o">};</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其根据一个 name 值，从 modules 中获取到指定的 module，进行读取里面的值，得到 ModuleConfig 信息。</p>

<h4>5.调用方法的暴露</h4>

<p>这里提供了两个方法，来提供调用 Native 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">ModuleRegistry:</span><span class="o">:</span><span class="n">callNativeMethod</span><span class="o">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">moduleId</span><span class="o">,</span> <span class="n">unsigned</span> <span class="kt">int</span> <span class="n">methodId</span><span class="o">,</span>
</span><span class='line'>                                      <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="o">&amp;&amp;</span><span class="n">params</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">moduleId</span> <span class="o">&gt;=</span> <span class="n">modules_</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">runtime_error</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;moduleId &quot;</span><span class="o">,</span> <span class="n">moduleId</span><span class="o">,</span> <span class="s">&quot; out of range [0..&quot;</span><span class="o">,</span> <span class="n">modules_</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span>
</span><span class='line'>                             <span class="s">&quot;)&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">modules_</span><span class="o">[</span><span class="n">moduleId</span><span class="o">]-&gt;</span><span class="n">invoke</span><span class="o">(</span><span class="n">methodId</span><span class="o">,</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">params</span><span class="o">),</span> <span class="n">callId</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">MethodCallResult</span>
</span><span class='line'><span class="nl">ModuleRegistry:</span><span class="o">:</span><span class="n">callSerializableNativeHook</span><span class="o">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">moduleId</span><span class="o">,</span> <span class="n">unsigned</span> <span class="kt">int</span> <span class="n">methodId</span><span class="o">,</span>
</span><span class='line'>                                           <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="o">&amp;&amp;</span><span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">moduleId</span> <span class="o">&gt;=</span> <span class="n">modules_</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">runtime_error</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;moduleId &quot;</span><span class="o">,</span> <span class="n">moduleId</span><span class="o">,</span> <span class="s">&quot;out of range [0..&quot;</span><span class="o">,</span> <span class="n">modules_</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span>
</span><span class='line'>                             <span class="s">&quot;)&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">modules_</span><span class="o">[</span><span class="n">moduleId</span><span class="o">]-&gt;</span><span class="n">callSerializableNativeHook</span><span class="o">(</span><span class="n">methodId</span><span class="o">,</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">params</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这两个方法执行的是 module 对应的方法，对应类为 CxxNativeModule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nl">CxxNativeModule:</span><span class="o">:</span><span class="n">invoke</span><span class="o">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">reactMethodId</span><span class="o">,</span> <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="o">&amp;&amp;</span><span class="n">params</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">reactMethodId</span> <span class="o">&gt;=</span> <span class="n">methods_</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">invalid_argument</span><span class="o">(</span><span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;methodId &quot;</span><span class="o">,</span> <span class="n">reactMethodId</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="s">&quot; out of range [0..&quot;</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="n">methods_</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="s">&quot;]&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(!</span><span class="n">params</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">invalid_argument</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;method parameters should be array, but are &quot;</span><span class="o">,</span>
</span><span class='line'>                             <span class="n">params</span><span class="o">.</span><span class="na">typeName</span><span class="o">()));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nl">CxxModule:</span><span class="o">:</span><span class="n">Callback</span> <span class="n">first</span><span class="o">;</span>
</span><span class='line'>  <span class="nl">CxxModule:</span><span class="o">:</span><span class="n">Callback</span> <span class="n">second</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">const</span> <span class="n">auto</span> <span class="o">&amp;</span><span class="n">method</span> <span class="o">=</span> <span class="n">methods_</span><span class="o">[</span><span class="n">reactMethodId</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">func</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">runtime_error</span><span class="o">(</span><span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;Method &quot;</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
</span><span class='line'>                                                    <span class="s">&quot; is synchronous but invoked asynchronously&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">method</span><span class="o">.</span><span class="na">callbacks</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">invalid_argument</span><span class="o">(</span><span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;Expected &quot;</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">callbacks</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="s">&quot; callbacks, but only &quot;</span><span class="o">,</span>
</span><span class='line'>                                                       <span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span>
</span><span class='line'>                                                       <span class="s">&quot; parameters provided&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">callbacks</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">first</span> <span class="o">=</span> <span class="n">convertCallback</span><span class="o">(</span><span class="n">makeCallback</span><span class="o">(</span><span class="n">instance_</span><span class="o">,</span> <span class="n">params</span><span class="o">[</span><span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]));</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">callbacks</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">first</span> <span class="o">=</span> <span class="n">convertCallback</span><span class="o">(</span><span class="n">makeCallback</span><span class="o">(</span><span class="n">instance_</span><span class="o">,</span> <span class="n">params</span><span class="o">[</span><span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">]));</span>
</span><span class='line'>    <span class="n">second</span> <span class="o">=</span> <span class="n">convertCallback</span><span class="o">(</span><span class="n">makeCallback</span><span class="o">(</span><span class="n">instance_</span><span class="o">,</span> <span class="n">params</span><span class="o">[</span><span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span><span class="o">.</span><span class="na">resize</span><span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">method</span><span class="o">.</span><span class="na">callbacks</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">messageQueueThread_</span><span class="o">-&gt;</span><span class="n">runOnQueue</span><span class="o">(</span>
</span><span class='line'>    <span class="o">[</span><span class="n">method</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">params</span><span class="o">),</span> <span class="n">first</span><span class="o">,</span> <span class="n">second</span><span class="o">,</span> <span class="n">callId</span><span class="o">]()</span> <span class="o">{</span>
</span><span class='line'><span class="err">#</span><span class="n">ifdef</span> <span class="n">WITH_FBSYSTRACE</span>
</span><span class='line'>        <span class="nf">if</span> <span class="o">(</span><span class="n">callId</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">fbsystrace_end_async_flow</span><span class="o">(</span><span class="n">TRACE_TAG_REACT_APPS</span><span class="o">,</span> <span class="s">&quot;native&quot;</span><span class="o">,</span> <span class="n">callId</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="err">#</span><span class="n">endif</span>
</span><span class='line'>        <span class="n">SystraceSection</span> <span class="nf">s</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">c_str</span><span class="o">());</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">method</span><span class="o">.</span><span class="na">func</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">params</span><span class="o">),</span> <span class="n">first</span><span class="o">,</span> <span class="n">second</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">const</span> <span class="nl">facebook:</span><span class="o">:</span><span class="nl">xplat:</span><span class="o">:</span><span class="n">JsArgumentException</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">LOG</span><span class="o">(</span><span class="n">ERROR</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;std::exception. Method call &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">c_str</span><span class="o">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed: &quot;</span>
</span><span class='line'>                     <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="o">.</span><span class="na">what</span><span class="o">();</span>
</span><span class='line'>          <span class="nl">std:</span><span class="o">:</span><span class="n">terminate</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">LOG</span><span class="o">(</span><span class="n">ERROR</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;std::string. Method call &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">c_str</span><span class="o">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed: &quot;</span>
</span><span class='line'>                     <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="o">.</span><span class="na">c_str</span><span class="o">();</span>
</span><span class='line'>          <span class="nl">std:</span><span class="o">:</span><span class="n">terminate</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(...)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">LOG</span><span class="o">(</span><span class="n">ERROR</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Method call &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">c_str</span><span class="o">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; failed. unknown error&quot;</span><span class="o">;</span>
</span><span class='line'>          <span class="nl">std:</span><span class="o">:</span><span class="n">terminate</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 invoke 方法中，会解析参数，确定 callback 的数量，之后便是在指定的 MessageQueue 中执行方法的调用。同理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">MethodCallResult</span>
</span><span class='line'><span class="nl">CxxNativeModule:</span><span class="o">:</span><span class="n">callSerializableNativeHook</span><span class="o">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">hookId</span><span class="o">,</span> <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="o">&amp;&amp;</span><span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">hookId</span> <span class="o">&gt;=</span> <span class="n">methods_</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">invalid_argument</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;methodId &quot;</span><span class="o">,</span> <span class="n">hookId</span><span class="o">,</span> <span class="s">&quot; out of range [0..&quot;</span><span class="o">,</span> <span class="n">methods_</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span>
</span><span class='line'>                             <span class="s">&quot;]&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">const</span> <span class="n">auto</span> <span class="o">&amp;</span><span class="n">method</span> <span class="o">=</span> <span class="n">methods_</span><span class="o">[</span><span class="n">hookId</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">syncFunc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nl">std:</span><span class="o">:</span><span class="n">runtime_error</span><span class="o">(</span>
</span><span class='line'>      <span class="nl">folly:</span><span class="o">:</span><span class="n">to</span><span class="o">&lt;</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&gt;(</span><span class="s">&quot;Method &quot;</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
</span><span class='line'>                             <span class="s">&quot; is asynchronous but invoked synchronously&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">syncFunc</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>callSerialiableNativeHook 则是进行方法同步的调用。</p>

<h2>Native 调用 JS</h2>

<p>将 JS 端定义的对象方法来提供给 Native 端调用。</p>

<h3>1.步骤</h3>

<ul>
<li>1）Native端声明定义一个实现 JavaScriptModule 接口的类</li>
<li>2) 在 JS 端，实现定义此 Module，并将此对象添加注册至 MessageQueue 中.</li>
</ul>


<p>在 MessageQueue.js 中，提供了两个用来注册 Module 的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">registerCallableModule</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">module</span><span class="o">:</span> <span class="nb">Object</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>以及懒加载方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">registerLazyCallableModule</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">factory</span><span class="o">:</span> <span class="k">void</span> <span class="o">=&gt;</span> <span class="nb">Object</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.实现</h3>

<h4>1.定义 JavaScriptModule</h4>

<p>在 Native 中定义了 <code>JavaScriptModule</code>，代表了在 JS 端定义的 JS 方法。</p>

<p>若需要调用 JS 端的方法时，使用 <code>CatalystInstance</code> 接口的 <code>getJSModule</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">JavaScriptModule</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getJSModule</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">jsInterface</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>如调用 <code>AppRegistry</code> 的 <code>runApplication</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">catalystInstance</span><span class="o">.</span><span class="na">getJSModule</span><span class="o">(</span><span class="n">AppRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">runApplication</span><span class="o">(</span><span class="n">jsAppModuleName</span><span class="o">,</span> <span class="n">appParams</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.调用过程</h4>

<p>获取 JavaScriptModule 的方法，则是在 JavaScriptModuleRegistry 了中，其对 JavaScriptModule 类的获取，做了缓存策略，这里使用了代理调用，来改变其方法的调用。具体便是通过 JavaScriptModuleInvocationHandler 的 invoke 方法，来通过 CatalystInstance 来完成真正 JS 方法的调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="nd">@Nullable</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'><span class="n">NativeArray</span> <span class="n">jsArgs</span> <span class="o">=</span> <span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>  <span class="o">?</span> <span class="n">Arguments</span><span class="o">.</span><span class="na">fromJavaArgs</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>  <span class="o">:</span> <span class="k">new</span> <span class="nf">WritableNativeArray</span><span class="o">();</span>
</span><span class='line'>  <span class="n">mCatalystInstance</span><span class="o">.</span><span class="na">callFunction</span><span class="o">(</span><span class="n">getJSModuleName</span><span class="o">(),</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">jsArgs</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于 CatalystInstance 在 C 层的实现，对应着 CatalystInstanceImpl.cpp 的类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">CatalystInstanceImpl:</span><span class="o">:</span><span class="n">jniCallJSFunction</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="n">module</span><span class="o">,</span> <span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="n">method</span><span class="o">,</span> <span class="n">NativeArray</span><span class="o">*</span> <span class="n">arguments</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">instance_</span><span class="o">-&gt;</span><span class="n">callJSFunction</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">module</span><span class="o">),</span>
</span><span class='line'>                            <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">method</span><span class="o">),</span>
</span><span class='line'>                            <span class="n">arguments</span><span class="o">-&gt;</span><span class="n">consume</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>instance_ 是指 Instance.cpp 类的实例，会调用到：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">Instance:</span><span class="o">:</span><span class="n">callJSFunction</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="n">module</span><span class="o">,</span> <span class="nl">std:</span><span class="o">:</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="n">method</span><span class="o">,</span>
</span><span class='line'>                              <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span> <span class="o">&amp;&amp;</span><span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">callback_</span><span class="o">-&gt;</span><span class="n">incrementPendingJSCalls</span><span class="o">();</span>
</span><span class='line'>  <span class="n">nativeToJsBridge_</span><span class="o">-&gt;</span><span class="n">callFunction</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">module</span><span class="o">),</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">method</span><span class="o">),</span>
</span><span class='line'>                                  <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">params</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其调用的便是 NativeToJsBridge.cpp 的 callFunction 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nl">NativeToJsBridge:</span><span class="o">:</span><span class="n">callFunction</span><span class="o">(</span>
</span><span class='line'>    <span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&amp;&amp;</span> <span class="n">module</span><span class="o">,</span>
</span><span class='line'>    <span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">,</span>
</span><span class='line'>    <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span><span class="o">&amp;&amp;</span> <span class="n">arguments</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">systraceCookie</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">runOnExecutorQueue</span><span class="o">([</span><span class="n">module</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">module</span><span class="o">),</span> <span class="n">method</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">method</span><span class="o">),</span> <span class="n">arguments</span> <span class="o">=</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">arguments</span><span class="o">),</span> <span class="n">systraceCookie</span><span class="o">]</span>
</span><span class='line'>    <span class="o">(</span><span class="n">JSExecutor</span><span class="o">*</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>       <span class="c1">// This is safe because we are running on the executor&#39;s thread: it won&#39;t</span>
</span><span class='line'>      <span class="c1">// destruct until after it&#39;s been unregistered (which we check above) and</span>
</span><span class='line'>      <span class="c1">// that will happen on this thread</span>
</span><span class='line'>      <span class="n">executor</span><span class="o">-&gt;</span><span class="n">callFunction</span><span class="o">(</span><span class="n">module</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">arguments</span><span class="o">);</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而 executor 便指的是 JSCExecutor.cpp 类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kt">void</span> <span class="nl">JSCExecutor:</span><span class="o">:</span><span class="n">callFunction</span><span class="o">(</span><span class="kd">const</span> <span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">moduleId</span><span class="o">,</span> <span class="kd">const</span> <span class="nl">std:</span><span class="o">:</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">methodId</span><span class="o">,</span> <span class="kd">const</span> <span class="nl">folly:</span><span class="o">:</span><span class="n">dynamic</span><span class="o">&amp;</span> <span class="n">arguments</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">SystraceSection</span> <span class="nf">s</span><span class="o">(</span><span class="s">&quot;JSCExecutor::callFunction&quot;</span><span class="o">);</span>
</span><span class='line'>   <span class="c1">// This weird pattern is because Value is not default constructible.</span>
</span><span class='line'>   <span class="c1">// The lambda is inlined, so there&#39;s no overhead.</span>
</span><span class='line'>   <span class="n">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="o">[&amp;]</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">JSContextLock</span> <span class="nf">lock</span><span class="o">(</span><span class="n">m_context</span><span class="o">);</span>
</span><span class='line'>     <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(!</span><span class="n">m_callFunctionReturnResultAndFlushedQueueJS</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">bindBridge</span><span class="o">();</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>       <span class="k">return</span> <span class="n">m_callFunctionReturnFlushedQueueJS</span><span class="o">-&gt;</span><span class="n">callAsFunction</span><span class="o">({</span>
</span><span class='line'>         <span class="n">Value</span><span class="o">(</span><span class="n">m_context</span><span class="o">,</span> <span class="nl">String:</span><span class="o">:</span><span class="n">createExpectingAscii</span><span class="o">(</span><span class="n">m_context</span><span class="o">,</span> <span class="n">moduleId</span><span class="o">)),</span>
</span><span class='line'>         <span class="n">Value</span><span class="o">(</span><span class="n">m_context</span><span class="o">,</span> <span class="nl">String:</span><span class="o">:</span><span class="n">createExpectingAscii</span><span class="o">(</span><span class="n">m_context</span><span class="o">,</span> <span class="n">methodId</span><span class="o">)),</span>
</span><span class='line'>         <span class="nl">Value:</span><span class="o">:</span><span class="n">fromDynamic</span><span class="o">(</span><span class="n">m_context</span><span class="o">,</span> <span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">arguments</span><span class="o">))</span>
</span><span class='line'>       <span class="o">});</span>
</span><span class='line'>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(...)</span> <span class="o">{</span>
</span><span class='line'>       <span class="nl">std:</span><span class="o">:</span><span class="n">throw_with_nested</span><span class="o">(</span>
</span><span class='line'>                              <span class="nl">std:</span><span class="o">:</span><span class="n">runtime_error</span><span class="o">(</span><span class="s">&quot;Error calling &quot;</span> <span class="o">+</span> <span class="n">moduleId</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">methodId</span><span class="o">));</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>   <span class="o">}();</span>
</span><span class='line'>   <span class="n">callNativeModules</span><span class="o">(</span><span class="nl">std:</span><span class="o">:</span><span class="n">move</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中的 m_callFunctionReturnResultAndFlushedQueueJS 是在 bindBridge 过程中，从 JS 全局对象 <code>__fbBatchedBridge</code> 中进行获取读到的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kt">void</span> <span class="nl">JSCExecutor:</span><span class="o">:</span><span class="n">bindBridge</span><span class="o">()</span> <span class="k">throw</span><span class="o">(</span><span class="n">JSException</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">SystraceSection</span> <span class="nf">s</span><span class="o">(</span><span class="s">&quot;JSCExecutor::bindBridge&quot;</span><span class="o">);</span>
</span><span class='line'>   <span class="nl">std:</span><span class="o">:</span><span class="n">call_once</span><span class="o">(</span><span class="n">m_bindFlag</span><span class="o">,</span> <span class="o">[</span><span class="k">this</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">auto</span> <span class="n">global</span> <span class="o">=</span> <span class="nl">Object:</span><span class="o">:</span><span class="n">getGlobalObject</span><span class="o">(</span><span class="n">m_context</span><span class="o">);</span>
</span><span class='line'>     <span class="n">auto</span> <span class="n">batchedBridgeValue</span> <span class="o">=</span> <span class="n">global</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;__fbBatchedBridge&quot;</span><span class="o">);</span>
</span><span class='line'>     <span class="k">if</span> <span class="o">(</span><span class="n">batchedBridgeValue</span><span class="o">.</span><span class="na">isUndefined</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">auto</span> <span class="n">requireBatchedBridge</span> <span class="o">=</span> <span class="n">global</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;__fbRequireBatchedBridge&quot;</span><span class="o">);</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(!</span><span class="n">requireBatchedBridge</span><span class="o">.</span><span class="na">isUndefined</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">batchedBridgeValue</span> <span class="o">=</span> <span class="n">requireBatchedBridge</span><span class="o">.</span><span class="na">asObject</span><span class="o">().</span><span class="na">callAsFunction</span><span class="o">({});</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(</span><span class="n">batchedBridgeValue</span><span class="o">.</span><span class="na">isUndefined</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">throw</span> <span class="nf">JSException</span><span class="o">(</span><span class="s">&quot;Could not get BatchedBridge, make sure your bundle is packaged correctly&quot;</span><span class="o">);</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">auto</span> <span class="n">batchedBridge</span> <span class="o">=</span> <span class="n">batchedBridgeValue</span><span class="o">.</span><span class="na">asObject</span><span class="o">();</span>
</span><span class='line'>     <span class="n">m_callFunctionReturnFlushedQueueJS</span> <span class="o">=</span> <span class="n">batchedBridge</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;callFunctionReturnFlushedQueue&quot;</span><span class="o">).</span><span class="na">asObject</span><span class="o">();</span>
</span><span class='line'>     <span class="n">m_invokeCallbackAndReturnFlushedQueueJS</span> <span class="o">=</span> <span class="n">batchedBridge</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;invokeCallbackAndReturnFlushedQueue&quot;</span><span class="o">).</span><span class="na">asObject</span><span class="o">();</span>
</span><span class='line'>     <span class="n">m_flushedQueueJS</span> <span class="o">=</span> <span class="n">batchedBridge</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;flushedQueue&quot;</span><span class="o">).</span><span class="na">asObject</span><span class="o">();</span>
</span><span class='line'>     <span class="n">m_callFunctionReturnResultAndFlushedQueueJS</span> <span class="o">=</span> <span class="n">batchedBridge</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;callFunctionReturnResultAndFlushedQueue&quot;</span><span class="o">).</span><span class="na">asObject</span><span class="o">();</span>
</span><span class='line'>   <span class="o">});</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而此 __fbBatchedBridge 的定义则是在 JS 端的 BatchedBridge.js 文件中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">MessageQueue</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;MessageQueue&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">BatchedBridge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessageQueue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Wire up the batched bridge on the global object so that we can call into it.</span>
</span><span class='line'><span class="c1">// Ideally, this would be the inverse relationship. I.e. the native environment</span>
</span><span class='line'><span class="c1">// provides this global directly with its script embedded. Then this module</span>
</span><span class='line'><span class="c1">// would export it. A possible fix would be to trim the dependencies in</span>
</span><span class='line'><span class="c1">// MessageQueue to its minimal features and embed that in the native runtime.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="s1">&#39;__fbBatchedBridge&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">value</span><span class="o">:</span> <span class="nx">BatchedBridge</span><span class="p">,</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">BatchedBridge</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里其值则是对应着 MessageQueue，其管理着 JS 端的 function 的注册调用逻辑，其中<code>callFunctionReturnResultAndFlushedQueue</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">callFunctionReturnFlushedQueue</span><span class="p">(</span><span class="nx">module</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">__guard</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">__callFunction</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">flushedQueue</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>__callFunction</code> 方法的调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">__callFunction</span><span class="p">(</span><span class="nx">module</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="o">:</span> <span class="nx">any</span><span class="p">[])</span><span class="o">:</span> <span class="nx">any</span> <span class="p">{</span>
</span><span class='line'> <span class="k">this</span><span class="p">.</span><span class="nx">_lastFlush</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
</span><span class='line'> <span class="k">this</span><span class="p">.</span><span class="nx">_eventLoopStartTime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_lastFlush</span><span class="p">;</span>
</span><span class='line'> <span class="nx">Systrace</span><span class="p">.</span><span class="nx">beginEvent</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">module</span><span class="p">}.</span><span class="nx">$</span><span class="p">{</span><span class="nx">method</span><span class="p">}()</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__spy</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">this</span><span class="p">.</span><span class="nx">__spy</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="nx">TO_JS</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">});</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'> <span class="kr">const</span> <span class="nx">moduleMethods</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCallableModule</span><span class="p">(</span><span class="nx">module</span><span class="p">);</span>
</span><span class='line'> <span class="nx">invariant</span><span class="p">(</span>
</span><span class='line'>   <span class="o">!!</span><span class="nx">moduleMethods</span><span class="p">,</span>
</span><span class='line'>   <span class="s1">&#39;Module %s is not a registered callable module (calling %s)&#39;</span><span class="p">,</span>
</span><span class='line'>   <span class="nx">module</span><span class="p">,</span>
</span><span class='line'>   <span class="nx">method</span><span class="p">,</span>
</span><span class='line'> <span class="p">);</span>
</span><span class='line'> <span class="nx">invariant</span><span class="p">(</span>
</span><span class='line'>   <span class="o">!!</span><span class="nx">moduleMethods</span><span class="p">[</span><span class="nx">method</span><span class="p">],</span>
</span><span class='line'>   <span class="s1">&#39;Method %s does not exist on module %s&#39;</span><span class="p">,</span>
</span><span class='line'>   <span class="nx">method</span><span class="p">,</span>
</span><span class='line'>   <span class="nx">module</span><span class="p">,</span>
</span><span class='line'> <span class="p">);</span>
</span><span class='line'> <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">moduleMethods</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">moduleMethods</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'> <span class="nx">Systrace</span><span class="p">.</span><span class="nx">endEvent</span><span class="p">();</span>
</span><span class='line'> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中的 getCallableModule 则是从 _lazyCallableModules 中进行获取，其注册则是通过 <code>registerCallableModule</code> 方法。以 <code>AppRegistry.js</code> 为例，在其文件的末尾则是调用了 BatchedBridge 进行注册：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">BatchedBridge</span><span class="p">.</span><span class="nx">registerCallableModule</span><span class="p">(</span><span class="s1">&#39;AppRegistry&#39;</span><span class="p">,</span> <span class="nx">AppRegistry</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>



</div>



  <blockquote><p>版权归作者所有，转载请注明原文链接：<a href= "/blog/2018/06/28/react-native-message-theory/">/blog/2018/06/28/react-native-message-theory/</a></p></blockquote>

  <p class="meta" style="text-align: center;">
  <span>给 Ta 个打赏吧...</span><br/><br/>
    <img style="width: 80%;" src="/images/donate.png"/>
  </p>
  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">alighters</span></span>

      




<time class='entry-date' datetime='2018-06-28T16:28:00+08:00'><span class='date'>2018-06-28</span> <span class='time'>4:28 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/react-native/'>react-native</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://alighters.github.io/blog/blog/2018/06/28/react-native-message-theory/" data-via="david.wei" data-counturl="http://alighters.github.io/blog/blog/2018/06/28/react-native-message-theory/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/03/16/leakcanary-learn/" title="Previous Post: LeakCanary 浅析">&laquo; LeakCanary 浅析</a>
      
      
        <a class="basic-alignment right" href="/blog/2019/03/22/docker-config-ssr/" title="Next Post: Docker config ssr">Docker config ssr &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p>Android程序猿，Ruby、React爱好者，Vim党，喜欢简单、看书、思考</p>
  <p>QQ群：</p>
  <img src="http://alighters.github.io/imgs/android-qq.png"/>
</section>
<section>
  <h1>最近文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/03/22/docker-config-ssr/">Docker Config Ssr</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/28/react-native-message-theory/">RN 通信</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/16/leakcanary-learn/">LeakCanary 浅析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/02/kotlin-dsl-learn/">Kotlin DSL 学习</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/25/understand-imageloader/">图片加载理解之 UIL</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/23/reactnative-seprate-js/">React Native 之 JS 分离</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/16/multidex-generate/">理解 Multidex 生成</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/01/multidex-problems/">Multidex 的问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/01/create-gradle-plugin/">创建 Gradle Plugin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/27/bit-skill/">位运算之巧用</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/alighters">@alighters</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alighters',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  版权 &copy; 2020 - alighters -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'alighters';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://alighters.github.io/blog/blog/2018/06/28/react-native-message-theory/';
        var disqus_url = 'http://alighters.github.io/blog/blog/2018/06/28/react-native-message-theory/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
